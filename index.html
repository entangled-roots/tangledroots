<!DOCTYPE HTML>
<html>
<head>
    <title>Rooted</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MVWJ3CK38C"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MVWJ3CK38C');
    </script>

    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="search.css" />

    <!-- Leaflet Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Control Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        #map {
            height: 80vh;
            width: 114%;
            position: relative;
            left: -7%;
        }
    </style>
</head>
<body class="is-preload">

    <!-- Navbar -->
    <div class="navbar">
        <a href="#intro">Roots Map</a>
        <a href="#add">Add Community</a>
        <a href="#kinship">Kinship Project</a>
    </div>

    <!-- Header -->
    <section id="header" class="dark">
        <video autoplay muted loop playsinline id="background-video">
            <source src="images/IMG_0401.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="header-content">
            <header id="header-description">
                <h1>Rooted</h1>
                <p>Discover communities dedicated to exploring the natural world,<br>
                    from community gardens, conservation projects, to wild food initiatives and herbalism. p</p>
            </header>
            <footer id="'footer-content">
                <a href="#map" class="button scrolly">Community Map</a>
            </footer> 
        </div>
    </section>

    <!-- Community Map Section -->
    <section id="intro" class="main">
        <header>
            <div class="container">
                <h2 style="font-weight: bold;">Community Map</h2>
                <p>Rooted are creating a map of communities dedicated to foraging, herbalism, permaculture, community gardening, and more—where nature’s wisdom meets grassroots connection. 
                The aim is to help people easily find communities whether moving to a new city, knowing what’s going on in your current area, or visiting new places.</p>
            </div>
            <div class="container" style="text-align: center;">
                <p>Look for the following icons on the map to find communities:</p>
                <div style="display: flex; justify-content: center; gap: 40px; align-items: center;">
                    <div style="text-align: center;">
                        <img src="images/foraging.png" alt="Foraging Icon" style="width: 40px; height: 40px;" />
                        <p>Foraging</p>
                    </div>
                    <div style="text-align: center;">
                        <img src="images/growing.png" alt="Growing Icon" style="width: 40px;" />
                        <p>Growing</p>
                    </div>
                    <div style="text-align: center;">
                        <img src="images/permaculture.png" alt="Permaculture Icon" style="width: 40px;" />
                        <p>Permaculture</p>
                    </div>
                    <div style="text-align: center;">
                        <img src="images/community-garden.png" alt="Community Garden Icon" style="width: 40px;" />
                        <p>Community Garden</p>
                    </div>
                    <div style="text-align: center;">
                        <img src="images/herbalism.png" alt="Herbalism Icon" style="width: 40px;" />
                        <p>Herbalism</p>
                    </div>
                </div>
            </div>
        </header>

        <div id="map"></div>

        <footer id="footer">
            <p class="copyright">&copy; Rooted. Design: HTML5 UP</p>
        </footer>
    </section>

    <!-- Add Community Section -->
    <section id="add" class="main special">
        <div class="container">
            <header class="major special">
                <h2>Community Submission Form</h2>
                <p>Have a community to add? Please fill out the form below. Your submission will be reviewed before going live on the map.</p>
            </header>

            <form id="communityForm">
                <div class="row gtr-uniform">
                    <div class="col-6 col-12-xsmall">
                        <input type="text" name="name" id="name" placeholder="Community Name" required />
                    </div>
                    <div class="col-6 col-12-xsmall">
                        <input type="text" name="street" id="street" placeholder="Street Address" required />
                    </div>
                    <div class="col-6 col-12-xsmall">
                        <input type="text" name="postcode" id="postcode" placeholder="Postcode" required />
                    </div>
                    <div class="col-6 col-12-xsmall">
                        <input type="text" name="city" id="city" placeholder="City" required />
                    </div>
                    <div class="col-6 col-12-xsmall">
                        <select name="category" id="category" required>
                            <option value="">Choose category</option>
                            <option value="foraging">Foraging</option>
                            <option value="growing">Growing</option>
                            <option value="permaculture">Permaculture</option>
                            <option value="community_garden">Community Garden</option>
                            <option value="herbalism">Herbalism</option>
                        </select>
                    </div>
                    <div class="col-6 col-12-xsmall">
                        <input type="email" name="email" id="email" placeholder="Email Address" />
                    </div>
                    <div class="col-12">
                        <textarea name="description" id="description" placeholder="Description or Comments" rows="4"></textarea>
                    </div>
                    <div class="col-12">
                        <input type="text" name="website" id="website" placeholder="Website URL" />
                    </div>
                    <div class="col-12">
                        <ul class="actions">
                            <li><button type="submit" class="primary">Submit Community</button></li>
                        </ul>
                    </div>
                </div>
            </form>

            <div id="formMessage"></div>
        </div>
    </section>

    <!-- Kinship Project Section -->
    <section id="kinship" class="main">
        <div class="container">
            <header class="major special">
                <h2>Rooted Kinship Project</h2>
            </header>
            <p>This site is an ongoing experiment exploring the role of kinship with nature through communal knowledge sharing. We welcome feedback and contributions from the community.</p>
        </div>
    </section>

    <!-- Scripts -->
    <script>
        // Initialize Leaflet Map
        const map = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        // Fetch and add markers
        async function loadLocations() {
            try {
                const response = await fetch('https://location-tracker-backend-y5id.onrender.com/locations.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(Boolean);
                if(lines.length < 2) return;
                const headers = lines[0].split(',');
                for(let i=1; i<lines.length; i++) {
                    const cols = lines[i].split(',');
                    const lat = parseFloat(cols[11]);
                    const lon = parseFloat(cols[12]);
                    if(!isNaN(lat) && !isNaN(lon)) {
                        const marker = L.marker([lat, lon]).addTo(map);
                        marker.bindPopup(`<strong>${cols[0]}</strong><br>${cols[1]}, ${cols[2]}, ${cols[3]}<br>${cols[5]}`);
                    }
                }
            } catch(e) {
                console.error("Failed to load locations:", e);
            }
        }

        loadLocations();

        // Handle form submission
        const form = document.getElementById('communityForm');
        const messageDiv = document.getElementById('formMessage');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                name: form.name.value.trim(),
                street: form.street.value.trim(),
                postcode: form.postcode.value.trim(),
                city: form.city.value.trim(),
                category: form.category.value,
                description: form.description.value.trim(),
                email: form.email.value.trim(),
                website: form.website.value.trim()
            };

            try {
                const response = await fetch('https://location-tracker-backend-y5id.onrender.com/community', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                if(response.ok) {
                    const result = await response.json();
                    if(result.status === 'submitted') {
                        messageDiv.textContent = "Thank you! Your submission has been received and is pending approval.";
                        form.reset();
                    } else {
                        messageDiv.textContent = "Unexpected response from server.";
                    }
                } else {
                    messageDiv.textContent = `Error submitting form: ${response.statusText}`;
                }
            } catch (error) {
                messageDiv.textContent = `Error submitting form: ${error.message}`;
            }
        });
    </script>
</body>
</html>
